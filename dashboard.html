<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AFPPGMC</title>
    <link rel="stylesheet" href="style.css" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    

</head>
<body>
        <div class="main-content">        
<div class="header">
    <div>
        <img src="C:\Users\pgmci\Desktop\afp_webview\assets\pgmc_logo.png" alt="Your Image" class="logo">
        <h1>AFPPGMC</h1>
    </div>
    <div>
        <p>Good day, <span id="username">Admin</span></p>
    </div>
</div>
<div class="search-container">
    <input type="text" id="searchInput" placeholder="Search by Name, Pensioner No., Category...">
</div>
<div class="admin-container">
    <div class="sidebar">
        <button id="addAccountBtn">Add Account</button>
        <button id="updateAccountBtn">Update Account</button>
        <button id="viewLogsBtn">View Logs</button>
        <button id="signOutBtn">Sign Out</button>
    </div>
<div class="dashboard-container">
    <table>
        <thead>
            <tr>
                <th>Pensioner No.</th>
                <th>Full Name</th>
                <th>Category</th>
                <th>Serial Number</th>
                <th>Task</th>
            </tr>
        </thead>
        <tbody id="dataTable"></tbody>
    </table>
</div>
</div>
</div>

<!-- Modal Structure -->
<div class="overlay" onclick="closeModal()"></div>
<div class="modal">
    <div class="modal-header">
        <h2>Beneficiary Information</h2> <span id="submissionDate">Submission Date: </span>
        <span class="modal-close">&times;</span>
    </div>
    <div class="modal-body">
        <div class="modal-left">
            <div class="modal-circle">
                <img src="" alt="2x2 Picture" /> <!-- This img tag will display the picture -->
            </div>
            <button class="submitUpdateButton">Submit</button>
        </div>
        <div class="modal-right">
            <div class="input-label">Full Name:</div>
            <input type="text" class="modal-input fullName" placeholder="Full Name" readonly>

            <div class="input-label">Home Address:</div>
            <input type="text" class="modal-input localAddress" placeholder="Home Address" readonly>
        
            <div class="input-row">
                <div>
                    <div class="input-label">Pensioner Status:</div>
                    <input type="text" class="modal-input pensionerStatus" placeholder="Pensioner Status" readonly>
                </div>
                <div>
                    <div class="input-label">Beneficiary Type:</div>
                    <input type="text" class="modal-input beneficiaryType" placeholder="Beneficiary Type" readonly>
                </div>
            </div>
            
            <div class="input-row">
                <div>
            <div class="input-label">Serial Number:</div>
            <input type="text" class="modal-input serialNumber" placeholder="Serial Number" readonly>
                </div>
                 <div>
                    <div class="input-label">Birthday:</div>
                    <input type="text" class="modal-input birthday" placeholder="Birthday" readonly>
                </div>
            </div>
            
            <div class="input-row">
                <div>
            <div class="input-label">Phone Number:</div>
            <input type="text" class="modal-input phoneNumber" placeholder="Phone Number" readonly>
            </div>
            <div>
            <div class="input-label">CRS:</div>
            <input type="text" class="modal-input CRS" placeholder="CRS" readonly>
        </div>
    </div>

            <div class="modal-file">
                ID File: <button class="idFileViewButton" onclick="">View</button>
                Video Clip: <button class="videoClipViewButton" onclick="">View</button>
                Ret Order: <button class="retOrderViewButton" onclick="">View</button>
            </div>
            <div class="if-abroad">
                ------------------IF ABROAD------------------
            </div>        
            <div class="modal-file">
                Oath of Allegiance: <button class="oathofAllegianceViewButton" onclick="">View</button>
            </div>
            <div class="modal-file">
                Certificate of Naturalization: <button class="certofNaturalizationViewButton" onclick="">View</button>
            </div>
            <div class="modal-file">
                Passport: <button class="passportViewButton" onclick="">View</button>
            </div>
            <div class="modal-file">
                Identification of Dual Citizenship: <button class="identificationDualCitizenViewButton" onclick="">View</button>
            </div>
            <div class="input-label">Abroad Address:</div>
            <input type="text" class="modal-input abroadAddress" placeholder="Abroad Address" readonly>
        </div>
    </div>
</div>

<script type="module" defer>
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, getDoc, updateDoc, deleteDoc, addDoc, query, where, orderBy, Timestamp, writeBatch} from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
   
    const firebaseConfig = {
        apiKey: "AIzaSyDsyk_8UEvXjLbqzlHnpafyBwFrAU7Z3EE",
        authDomain: "afppgmc-82e1e.firebaseapp.com",
        projectId: "afppgmc-82e1e",
        storageBucket: "afppgmc-82e1e.appspot.com",
        messagingSenderId: "887190525745",
        appId: "1:887190525745:web:d73eb6c173f1817a21c210",
        measurementId: "G-GMGN94TNJ3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    

    function updateFileAvailability(modal, data, buttonSelector, fileField) {
    const button = modal.querySelector(buttonSelector);
    if (!button) {
        console.error(`${buttonSelector} not found in the modal.`);
        return;
    }

    let latestFileUrl = '';
    if (data[fileField] && Array.isArray(data[fileField])) {
        const latestFile = data[fileField].sort((a, b) => b.timestamp - a.timestamp)[0];
        latestFileUrl = latestFile ? latestFile.url : '';
    }

    if (latestFileUrl) {
        button.setAttribute('onclick', `window.open('${latestFileUrl}', '_blank')`);
        button.removeAttribute('disabled');
        button.textContent = 'View';
    } else {
        button.setAttribute('disabled', true);
        button.textContent = 'Unavailable';
    }
}

    window.openModal = async function(docId) {
    const modal = document.querySelector('.modal');
    const overlay = document.querySelector('.overlay');
    const docRef = doc(db, "users", docId); // Ensure 'doc' and 'db' are correctly imported and initialized
    const docSnap = await getDoc(docRef);

    const submissionDateElement = document.getElementById('submissionDate');

    // Reset the submission date text content each time the modal is opened
    submissionDateElement.textContent = 'Submission Date: ';
        

    const submitButton = document.querySelector('.submitUpdateButton');
    if (submitButton) {
        submitButton.style.display = 'none'; // Hide the button
    }
        
        
    if (docSnap.exists()) {
        const data = docSnap.data();
        const submissionDateElement = document.getElementById('submissionDate');

        const idFileField = data.pensionerStatus === 'Principal' ? 'pensionID_files' : 'normalID_files';

        updateFileAvailability(modal, data, '.idFileViewButton', idFileField);
        updateFileAvailability(modal, data, '.videoClipViewButton', 'videoClip_files');
        updateFileAvailability(modal, data, '.retOrderViewButton', 'retOrder_files');
        updateFileAvailability(modal, data, '.oathofAllegianceViewButton', 'oathofAllegiance_files');
        updateFileAvailability(modal, data, '.certofNaturalizationViewButton', 'certofNaturalization_files');
        updateFileAvailability(modal, data, '.identificationDualCitizenViewButton', 'identificationDualCitizen_files');
        updateFileAvailability(modal, data, '.passportViewButton', 'passport_files');
        

        // Constructing the birthday string
        let birthday = 'No birthday provided';
        if (data.birthday && typeof data.birthday === 'object') {
            birthday = `${data.birthday.month || 'Unknown'} / ${data.birthday.day || 'Unknown'} / ${data.birthday.year || 'Unknown'}`;
        }
        

        // Set the values for your inputs
        modal.querySelector('.modal-input.fullName').value = data.fullName || 'No name provided';
        modal.querySelector('.modal-input.pensionerStatus').value = data.pensionerStatus || 'No status provided';
        modal.querySelector('.modal-input.beneficiaryType').value = data.beneficiaryType || 'No status provided';
        modal.querySelector('.modal-input.serialNumber').value = data.serialNumber || 'No serial number provided';
        modal.querySelector('.modal-input.localAddress').value = data.localAddress || 'No address provided';
        modal.querySelector('.modal-input.birthday').value = birthday;
        modal.querySelector('.modal-input.phoneNumber').value = data.phoneNumber || 'No phone number provided';
        modal.querySelector('.modal-input.abroadAddress').value = data.abroadAddress || 'No Abroad Address provided';

        if (data.submitTimestamp && data.submitTimestamp.toDate) {
    const submitDate = data.submitTimestamp.toDate();
    // Specify your desired options for toLocaleString
    const options = { 
        year: 'numeric', month: 'long', day: 'numeric', 
        hour: 'numeric', minute: 'numeric', second: 'numeric', 
        timeZoneName: 'short', hour12: true 
    };
    const formattedDate = submitDate.toLocaleString("en-US", options);
    submissionDateElement.textContent += formattedDate;
    submissionDateElement.style.color = 'red';
} else {
    submissionDateElement.textContent += 'Not available';
    submissionDateElement.style.color = 'red';
}


        let latestPictureUrl = 'assets/nopp.png'; // default picture
    if (data['2x2Picture_files'] && Array.isArray(data['2x2Picture_files'])) {
        const latestPicture = data['2x2Picture_files'].sort((a, b) => b.timestamp - a.timestamp)[0];
        latestPictureUrl = latestPicture ? latestPicture.url : latestPictureUrl;
    }

    // Set the image source for the 2x2 Picture
    const imageElement = modal.querySelector('.modal-circle img');
    if (imageElement) {
        imageElement.src = latestPictureUrl;
    } else {
        console.error('Image element not found in the modal.');
    }

        // Conditionally display CRS4 or CRS5 based on the beneficiaryType
        const crsInput = modal.querySelector('.modal-input.CRS');
        if (data.beneficiaryType === 'Widow/Widower') {
            crsInput.value = data.CRS5 || 'No CRS5 provided';
        } else if (data.beneficiaryType === 'Child/Brother/Sister') {
            crsInput.value = data.CRS4 || 'No CRS4 provided';
        } else {
            crsInput.value = 'No CRS data provided';
        }


        const inputs = modal.querySelectorAll('.modal-input');
        inputs.forEach(input => input.setAttribute('readonly', true));
        // Display the modal and overlay
        modal.style.display = 'block';
        overlay.style.display = 'block';
    } else {
        console.log("No such document!");
    }
};



window.openModalForUpdate = async function(docId) {

    let currentDocId = docId;
    const modal = document.querySelector('.modal');
    const overlay = document.querySelector('.overlay');

    // Show the modal and overlay
    modal.style.display = 'block';
    overlay.style.display = 'block';

    // Fetch the document by ID
    const docRef = doc(db, "users", docId);
    const docSnap = await getDoc(docRef);

    const submissionDateElement = document.getElementById('submissionDate');

    // Reset the submission date text content each time the modal is opened
    submissionDateElement.textContent = 'Submission Date: ';

    // Check if the submit button already exists, create if it doesn't

    if (docSnap.exists()) {
        const data = docSnap.data();

        const viewButtons = modal.querySelectorAll('.idFileViewButton, .videoClipViewButton, .retOrderViewButton, .oathofAllegianceViewButton, .certofNaturalizationViewButton, .passportViewButton, .identificationDualCitizenViewButton');
        viewButtons.forEach(button => {
            button.disabled = true; // Disable the button
            button.textContent = 'Unavailable'; // Optionally change the button text
        });


        // Constructing the birthday string
        let birthday = '';
        if (data.birthday && typeof data.birthday === 'object') {
            birthday = `${data.birthday.month || 'Unknown'} / ${data.birthday.day || 'Unknown'} / ${data.birthday.year || 'Unknown'}`;
        }

        // Populate the modal's input fields with the data
        modal.querySelector('.modal-input.fullName').value = data.fullName || '';
        modal.querySelector('.modal-input.pensionerStatus').value = data.pensionerStatus || '';
        modal.querySelector('.modal-input.beneficiaryType').value = data.beneficiaryType || '';
        modal.querySelector('.modal-input.serialNumber').value = data.serialNumber || '';
        modal.querySelector('.modal-input.localAddress').value = data.localAddress || '';
        modal.querySelector('.modal-input.birthday').value = birthday || '';
        modal.querySelector('.modal-input.phoneNumber').value = data.phoneNumber || '';
        modal.querySelector('.modal-input.abroadAddress').value = data.abroadAddress || '';

        const submissionDateElement = document.getElementById('submissionDate');

    // Check if submitTimestamp exists and is a Firestore timestamp
    if (data.submitTimestamp && data.submitTimestamp.toDate) {
    const submitDate = data.submitTimestamp.toDate();
    // Specify your desired options for toLocaleString
    const options = { 
        year: 'numeric', month: 'long', day: 'numeric', 
        hour: 'numeric', minute: 'numeric', second: 'numeric', 
        timeZoneName: 'short', hour12: true 
    };
    const formattedDate = submitDate.toLocaleString("en-US", options);
    submissionDateElement.textContent += formattedDate;
    submissionDateElement.style.color = 'red';
} else {
    submissionDateElement.textContent += 'Not available';
    submissionDateElement.style.color = 'red';
}
        // Continue for other fields...
        // Setting the image source for the 2x2 Picture
        let latestPictureUrl = 'assets/nopp.png'; // default picture
    if (data['2x2Picture_files'] && Array.isArray(data['2x2Picture_files'])) {
        const latestPicture = data['2x2Picture_files'].sort((a, b) => b.timestamp - a.timestamp)[0];
        latestPictureUrl = latestPicture ? latestPicture.url : latestPictureUrl;
    }

    // Set the image source for the 2x2 Picture
    const imageElement = modal.querySelector('.modal-circle img');
    if (imageElement) {
        imageElement.src = latestPictureUrl;
    } else {
        console.error('Image element not found in the modal.');
    }

        const beneficiaryTypeInput = modal.querySelector('.modal-input.beneficiaryType');

        // Conditionally display CRS4 or CRS5 based on the beneficiaryType
        const crsInput = modal.querySelector('.modal-input.CRS');
        if (data.beneficiaryType === 'Widow/Widower') {
            crsInput.value = data.CRS5 || 'No CRS5 provided';
        } else if (data.beneficiaryType === 'Child/Brother/Sister') {
            crsInput.value = data.CRS4 || 'No CRS4 provided';
        } else {
            crsInput.value = '';
        }

        // Make the input fields editable
        const inputs = modal.querySelectorAll('.modal-input');
        inputs.forEach(input => input.removeAttribute('readonly'));
        modal.style.display = 'block';
        overlay.style.display = 'block';
    } else {
        console.log("Document not found");
    }

    async function updateTable() {
    const tbody = document.getElementById('dataTable');
    tbody.innerHTML = ''; // Clear the existing table contents
    let stdNo = 0;

    const querySnapshot = await getDocs(collection(db, "users"));
    querySnapshot.forEach(doc => {
        const data = doc.data();
        AddItemToTable(data.fullName, data.pensionerStatus, data.serialNumber, doc.id, ++stdNo, tbody);
    });
}

    let submitButton = modal.querySelector('.submitUpdateButton');
    if (!submitButton) {
        submitButton = document.createElement('button');
        submitButton.textContent = 'Submit';
        submitButton.classList.add('submitUpdateButton');
        modal.querySelector('.modal-left').appendChild(submitButton); // Assuming you want it in '.modal-left'
    }

    // Ensure the submit button is visible
    submitButton.style.display = 'block';

    submitButton.onclick = async () => {
        // Confirm and perform update here
        if (confirm("Are you sure you want to update?")) {

            const fullName = await getFullNameFromFirestore(currentDocId);
        if (!fullName) {
            alert('Unable to retrieve full name for logging.');
            return; // Stop the operation if fullName cannot be retrieved
        }
            // Perform update operation...
            const updatedData = {
                fullName: modal.querySelector('.modal-input.fullName').value,
                pensionerStatus: modal.querySelector('.modal-input.pensionerStatus').value,
                beneficiaryType: modal.querySelector('.modal-input.beneficiaryType').value,
                serialNumber: modal.querySelector('.modal-input.serialNumber').value,
                localAddress: modal.querySelector('.modal-input.localAddress').value,
                phoneNumber: modal.querySelector('.modal-input.phoneNumber').value,
                abroadAddress: modal.querySelector('.modal-input.abroadAddress').value,
                // Include other fields you want to update...
                birthday: {}, // Initialize birthday as an empty object
            };

            // Extract the beneficiary type
            const beneficiaryType = modal.querySelector('.modal-input.beneficiaryType').value;

            // Based on the beneficiary type, update CRS4 or CRS5
            if (beneficiaryType === 'Widow/Widower') {
                updatedData.CRS5 = modal.querySelector('.modal-input.CRS').value; // Assuming you have an input field for CRS
            } else if (beneficiaryType === 'Child/Brother/Sister') {
                updatedData.CRS4 = modal.querySelector('.modal-input.CRS').value; // Assuming you have an input field for CRS
            }


            const birthdayInputValue = modal.querySelector('.modal-input.birthday').value;
            const birthdayParts = birthdayInputValue.split('/');

            if (birthdayParts.length === 3) {
                const monthString = birthdayParts[0].trim(); // Assuming the month is entered as a string, e.g., 'January'
                const day = parseInt(birthdayParts[1].trim(), 10);
                const year = parseInt(birthdayParts[2].trim(), 10);

                // You may want to add additional validation here to ensure the monthString is a valid month

                updatedData.birthday = {
                    month: monthString,
                    day: day,
                    year: year
                };
            } else {
                // Handle error for incorrect date format or notify the user
                alert('Please enter the birthday in "Month / DD / YYYY" format.');
                return; // Don't proceed with the update
            }

            // Firestore document reference
            const docRef = doc(db, "users", currentDocId);

            // Update the document in Firestore
            try {
    await updateDoc(docRef, updatedData);
    alert('Document successfully updated');
    logAction(`UPDATED the data of ${fullName} | Document ID: ${currentDocId}`, sessionStorage.getItem("fullName"));
    closeModal(); // Close the modal upon successful update
    await loadTableData(); // Refresh the dashboard table
    showRows(); // Enforce pagination display rules
} catch (error) {
    console.error("Error updating document: ", error);
    alert('Failed to update the document');
}
        }
    };
};
    window.closeModal = function() {
        const modal = document.querySelector('.modal');
        const overlay = document.querySelector('.overlay');
        modal.style.display = 'none';
        overlay.style.display = 'none';

        const submitButton = document.querySelector('.submitUpdateButton');
    if (submitButton) {
        submitButton.style.display = 'none';
    }
    };

    // AddItemToTable function
function AddItemToTable(name, ps, sn, docId, stdNo, tbody) {
    let trow = document.createElement("tr");
    trow.innerHTML = `
        <td>${stdNo}</td>
        <td>${name}</td>
        <td>${ps}</td>
        <td>${sn}</td>
        <td>
            <button class="action-buttonV" data-docid="${docId}">View</button>
            <button class="action-buttonU" data-docid="${docId}">Update</button>
            <button class="action-buttonD" data-docid="${docId}">Delete</button>
        </td>
    `;
    tbody.appendChild(trow);
}

// Delete document function
async function deleteDocument(docId) {
    const confirmDelete = confirm("Are you sure you want to delete this record?");
    // Retrieve full name for logging
    const fullName = await getFullNameFromFirestore(docId); // Use docId here
    if (!fullName) {
        alert('Unable to retrieve full name for logging.');
        return; // Stop the operation if fullName cannot be retrieved
    }
    
    if (confirmDelete) {
        try {
            await deleteDoc(doc(db, "users", docId)); // Use docId to reference the document to delete
            alert("Document successfully deleted!");
            logAction(`DELETED the data of ${fullName} | Document ID: ${docId}`, sessionStorage.getItem("fullName")); // Use docId for logging
            await loadTableData(); // Refresh table data, assuming this function is async
        } catch (error) {
            console.error("Error deleting document: ", error);
            alert("Failed to delete the document.");
        }
    }
}


// Load table data function
async function loadTableData() {
    const tbody = document.getElementById('dataTable');
    tbody.innerHTML = ''; // Clear table

    let stdNo = 0;
    const querySnapshot = await getDocs(collection(db, "users"));
    querySnapshot.forEach((doc) => {
        const data = doc.data();
        AddItemToTable(data.fullName, data.pensionerStatus, data.serialNumber, doc.id, ++stdNo, tbody);
    });
    showRows(); // Enforce pagination display rules after loading data
}

// DOMContentLoaded event listener
document.addEventListener('DOMContentLoaded', () => {
    loadTableData();

    const tableBody = document.getElementById('dataTable');
    tableBody.addEventListener('click', (event) => {
        const target = event.target;
        const docId = target.getAttribute('data-docid');

        if (target.matches('.action-buttonV')) {
            openModal(docId);
        } else if (target.matches('.action-buttonU')) {
            openModalForUpdate(docId);
        } else if (target.matches('.action-buttonD')) {
            deleteDocument(docId);
        }
        showRows();
    });
});

// Attach the event listener to the close button
document.addEventListener('DOMContentLoaded', () => {
    const closeButton = document.querySelector('.modal-close'); // Adjust the selector if necessary
    if (closeButton) {
        closeButton.addEventListener('click', closeModal);
    }
});

document.addEventListener('DOMContentLoaded', () => {
    const searchInput = document.getElementById('searchInput');

    searchInput.addEventListener('input', () => {
        const filter = searchInput.value.toUpperCase();
        const tbody = document.getElementById('dataTable');
        const tr = tbody.getElementsByTagName('tr');
        let displayCount = 0;

        // Loop through all table rows, and hide those that don't match the search query
        for (let i = 0; i < tr.length; i++) {
            tr[i].style.display = 'none'; // Initially hide all rows
            let td = tr[i].getElementsByTagName('td');
            for (let j = 0; j < td.length; j++) {
                if (td[j]) {
                    let txtValue = td[j].textContent || td[j].innerText;
                    if (txtValue.toUpperCase().indexOf(filter) > -1) {
                        if (displayCount < 10) { // Only display up to 10 rows
                            tr[i].style.display = '';
                            displayCount++;
                            break; // Stop checking other cells in the same row once a match is found
                        }
                    }
                }
            }
        }
    });
});


 // Modal functionality
 var modalAdd = document.getElementById("addAccountModal");
    var closeBtn = document.getElementsByClassName("close-buttonAdd")[0];

    // Event listener for Add Account button
    document.getElementById("addAccountBtn").addEventListener("click", function() {
        modalAdd.style.display = "block";
    });

    closeBtn.onclick = function() {
    modalAdd.style.display = "none"; // Close the modal

    // Select all input elements within the modal and clear their values
    const inputs = modalAdd.querySelectorAll('input');
    inputs.forEach(input => {
        input.value = ''; // Reset input fields to empty
    });
}

    window.onclick = function(event) {
        if (event.target == modalAdd) {
            modalAdd.style.display = "none";
            document.getElementById('addAccountForm').reset(); // Reset form fields
        }
    }

    document.getElementById('addAccountForm').addEventListener('submit', async function(e) {
  e.preventDefault(); // Prevent default form submission

  const fullName = document.getElementById('fullName').value;
  const phoneNumber = document.getElementById('phoneNumber').value;
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;
  const confirmPassword = document.getElementById('confirmPassword').value;

  // Simple password match check (Consider using more secure practices for production)
  if (password !== confirmPassword) {
    alert("Passwords do not match.");
    return; // Stop execution if passwords don't match
  }

  // Check for existing entries
  const exists = await checkForExistingEntries(phoneNumber, email);
  if (exists) {
    // Do not proceed with submission if there are existing entries
    return;
  }

  // If no existing entries, proceed with adding the new account
  try {
    const docRef = await addDoc(collection(db, "accounts"), {
      fullName: fullName,
      phoneNumber: phoneNumber,
      email: email,
      password: password // Note: Consider security implications of storing passwords
    });
    alert("Account Created Succesfully");

    console.log("Document written with ID: ", docRef.id);
    modalAdd.style.display = "none"; // Close the modal on successful submission
    document.getElementById('addAccountForm').reset(); // Reset form fields
  } catch (error) {
    console.error("Error adding document: ", error);
  }
});

// Function to check for existing entries
async function checkForExistingEntries(phoneNumber, email) {
  const accountsRef = collection(db, 'accounts');
  
  // Query for phone number
  const phoneQuery = query(accountsRef, where('phoneNumber', '==', phoneNumber));
  const phoneQuerySnapshot = await getDocs(phoneQuery);

  // Query for email
  const emailQuery = query(accountsRef, where('email', '==', email));
  const emailQuerySnapshot = await getDocs(emailQuery);

  if (!phoneQuerySnapshot.empty) {
    alert('A user with this phone number already exists.');
    return true; // Existing phone number found
  }

  if (!emailQuerySnapshot.empty) {
    alert('A user with this email already exists.');
    return true; // Existing email found
  }

  return false; // No existing entries found
}




document.addEventListener('DOMContentLoaded', function() {
    var updateModal = document.getElementById('updateAccountModal');
    var updateCloseBtn = updateModal.querySelector('.close-buttonUpdate');

    // Function to populate the dropdown with full names from Firestore
    async function populateDropdown() {
        const updateRoleSelect = document.getElementById('updateRole');
        updateRoleSelect.innerHTML = '<option value="">Select Account</option>'; // Clear current options
        
        const querySnapshot = await getDocs(collection(db, "accounts"));
        querySnapshot.forEach(doc => {
            const account = doc.data();
            const option = document.createElement('option');
            option.value = doc.id; // Use document ID as the value
            option.textContent = account.fullName; // Use fullName as the text content
            updateRoleSelect.appendChild(option);
        });
    }

    // Function to clear the Update Account form fields
    function clearUpdateAccountForm() {
        document.getElementById('updateFullName').value = '';
        document.getElementById('updatePhoneNumber').value = '';
        document.getElementById('updateEmail').value = '';
        document.getElementById('updatePassword').value = '';
        // Optionally clear other fields if needed
    }

    // Event listener for Update Account button
    document.getElementById('updateAccountBtn').addEventListener('click', function() {
        populateDropdown(); // Populate the dropdown when the Update modal is opened
        updateModal.style.display = 'block';
    });

    // Close button for Update Modal
    updateCloseBtn.addEventListener('click', function() {
        updateModal.style.display = 'none';
        clearUpdateAccountForm();
        document.getElementById('updateRole').selectedIndex = 0;
    });

    // Clicking outside the modal content but within the modal area will close the modal
    window.addEventListener('click', function(event) {
        if (event.target == updateModal) {
            updateModal.style.display = 'none';
            clearUpdateAccountForm();
            document.getElementById('updateRole').selectedIndex = 0;
        }
    });

    // Fetch and populate form when a name is selected from the dropdown
    document.getElementById('updateRole').addEventListener('change', async function() {
        const selectedAccountId = this.value;

        if (selectedAccountId) {
            const docRef = doc(db, "accounts", selectedAccountId);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const accountData = docSnap.data();
                document.getElementById('updateFullName').value = accountData.fullName || '';
                document.getElementById('updatePhoneNumber').value = accountData.phoneNumber || '';
                document.getElementById('updateEmail').value = accountData.email || '';
                document.getElementById('updatePassword').value = accountData.password || '';
            } else {
                console.log("No such document!");
                clearUpdateAccountForm();
            }
        } else {
            clearUpdateAccountForm();
        }
    });

    // Event listener for the Update Account form submission
    document.getElementById('updateAccountForm').addEventListener('submit', async function(e) {
        e.preventDefault(); // Prevent the default form submission

        const selectedAccountId = document.getElementById('updateRole').value;
        if (!selectedAccountId) {
            alert('Please select an account to update.');
            return;
        }
        
        const fullName = document.getElementById('updateFullName').value;
        const phoneNumber = document.getElementById('updatePhoneNumber').value;
        const email = document.getElementById('updateEmail').value;
        const password = document.getElementById('updatePassword').value;
        

        const emailExists = await checkForExistingField(selectedAccountId, 'email', email);
        if (emailExists) {
            alert('This email is already used by another account.');
            return; // Stop execution if email already exists
        }

        // Check for existing phone number in any other account
        const phoneExists = await checkForExistingField(selectedAccountId, 'phoneNumber', phoneNumber);
        if (phoneExists) {
            alert('This phone number is already used by another account.');
            return; // Stop execution if phone number already exists
        }

        // Reference to the Firestore document
        const accountRef = doc(db, 'accounts', selectedAccountId);

        // Update the document in Firestore
        try {
            await updateDoc(accountRef, {
                fullName: fullName,
                phoneNumber: phoneNumber,
                email: email,
                password: password
            });
            alert('Account updated successfully.');
            updateModal.style.display = 'none'; // Optionally close the modal after update
            clearUpdateAccountForm(); // Clear the form fields
            document.getElementById('updateRole').selectedIndex = 0; // Reset the dropdown
        } catch (error) {
            console.error('Error updating document: ', error);
            alert('Failed to update the account.');
        }
    });

    async function checkForExistingField(accountId, fieldName, fieldValue) {
        const accountsRef = collection(db, 'accounts');
        const q = query(accountsRef, where(fieldName, '==', fieldValue));
        const querySnapshot = await getDocs(q);

        // Check if any document with the same field value exists and is not the current account
        return querySnapshot.docs.some(doc => doc.id !== accountId);
    }
});


document.addEventListener('DOMContentLoaded', function() {
    const signOutBtn = document.getElementById('signOutBtn');

    // Check if the sign out button exists to avoid errors in pages without it
    if (signOutBtn) {
        signOutBtn.addEventListener('click', function() {
            const confirmation = confirm("Are you sure you want to sign out?");
            if (confirmation) {
                // User clicked 'OK'
                window.location.href = 'landingpage.html';
            }
        });
    }
});

document.addEventListener('DOMContentLoaded', () => {
            const fullName = sessionStorage.getItem("fullName"); // Retrieve the full name from session storage
            if (fullName) {
                document.getElementById('username').textContent = fullName; // Set the full name in the dashboard
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            const fullName = sessionStorage.getItem("fullName"); // Retrieve the full name from session storage
            document.getElementById('username').textContent = fullName; // Update greeting

            // Get buttons
            const addAccountBtn = document.getElementById('addAccountBtn');
            const updateAccountBtn = document.getElementById('updateAccountBtn');
            const viewLogsBtn = document.getElementById('viewLogsBtn');

            // Disable buttons if not Super Admin
            if (fullName !== "Super Admin") {
                addAccountBtn.disabled = true;
                updateAccountBtn.disabled = true;
                viewLogsBtn.disabled = true;
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
    const viewLogsBtn = document.getElementById('viewLogsBtn');
    const modalBackground = document.querySelector('.modalLogs-background');
    const closeLogsButton = document.querySelector('.closeLogs-button');

    // Function to show the modal
    const showModalLogs = () => {
        modalBackground.style.display = 'flex'; // Change to 'flex' to display the modal
    };

    // Function to close the modal
    const closeModalLogs = () => {
        modalBackground.style.display = 'none';
    };

    // Attach event listeners
    viewLogsBtn.addEventListener('click', showModalLogs);
    closeLogsButton.addEventListener('click', closeModalLogs);
});

async function getFullNameFromFirestore(docId) {
    const docRef = doc(db, "users", docId);
    const docSnap = await getDoc(docRef);
    if (docSnap.exists()) {
        const data = docSnap.data();
        // Retrieve fullName directly from the data object.
        const fullName = data.fullName || 'No fullName provided';
        return fullName;
    } else {
        console.log("No such document!");
        return null;
    }
}



const logs = []; // This array will hold all log entries

async function logAction(action, user) {
    const timestamp = new Date(); // Get current time
    const logEntry = {
        timestamp: timestamp.toLocaleString(), // Convert to Firestore Timestamp
        user: user,
        action: action
    };

    // Add the log entry to the local logs array
    logs.push(logEntry);
    
    // Display logs on the UI
    displayLogs();

    // Add the log entry to the Firestore database
    try {
        await addDoc(collection(db, "hlogs"), logEntry);
        console.log("Log entry added to Firestore");
    } catch (error) {
        console.error("Error adding log entry to Firestore: ", error);
    }
}


async function displayLogs() {
    const logContainer = document.querySelector('.modalLogs-body');
    logContainer.innerHTML = ''; // Clear previous logs to avoid duplication

    try {
        const logsQuery = query(collection(db, "hlogs"), orderBy("timestamp", "desc"));
        const querySnapshot = await getDocs(logsQuery);
        let logCount = 1; // Initialize log counter
        querySnapshot.forEach((doc) => {
            const log = doc.data();
            const logElement = document.createElement('div');
            logElement.classList.add('log-entry');

            // Create checkbox input for the log entry
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = 'log' + logCount;
            checkbox.classList.add('log-checkbox');
            checkbox.setAttribute('data-doc-id', doc.id);  // Set Firestore document ID to checkbox

            // Create a label for the checkbox
            const label = document.createElement('label');
            label.htmlFor = 'log' + logCount;
            label.textContent = `No.${logCount++} [${log.timestamp}] ${log.user}: ${log.action}`;

            // Append checkbox and label to logElement
            logElement.appendChild(checkbox);
            logElement.appendChild(label);
            logContainer.appendChild(logElement);
        });
    } catch (error) {
        console.error("Error fetching logs from Firestore: ", error);
    }
}


async function clearModalLogs() {
    // Ensure that the clear button properly handles clearing operations
    const confirmClear = confirm("Are you sure you want to clear all history logs?");
    if (!confirmClear) {
        return; // Stop the function if the user cancels
    }

    try {
        const querySnapshot = await getDocs(collection(db, "hlogs"));
        const batch = writeBatch(db); // Create a batch write operation

        querySnapshot.forEach((doc) => {
            batch.delete(doc.ref); // Add delete operation for each document to the batch
        });

        await batch.commit(); // Commit the batch delete operation
        console.log("All logs have been cleared from Firestore.");
        clearLogsUI(); // Also clear logs from the UI
        alert("All history logs have been cleared.");
        location.reload(); // Optional: Reload the page to refresh the state
    } catch (error) {
        console.error("Error clearing logs from Firestore: ", error);
        alert("Failed to clear history logs.");
    }
}

document.addEventListener('DOMContentLoaded', function() {
    displayLogs(); // Call the function to display logs on page load

    // Bind the search functionality after the DOM content is loaded to ensure the element is available
    document.getElementById('searchLogs').addEventListener('input', function(e) {
    const searchValue = e.target.value.toLowerCase();
    const logEntries = document.querySelectorAll('.modalLogs-body .log-entry'); // Use correct selector

    logEntries.forEach(entry => {
        const text = entry.textContent.toLowerCase();
        if (text.includes(searchValue)) {
            entry.style.display = '';
        } else {
            entry.style.display = 'none';
        }
    });
});

    const clearButton = document.querySelector('.clearLogs-button');
    if (clearButton) {
        clearButton.onclick = clearModalLogs;
    }
});


function clearLogsUI() {
    // Simplify the UI clearing function to avoid duplication
    const logContainer = document.querySelector('.modalLogs-body');
    logContainer.innerHTML = '';
}
document.addEventListener('DOMContentLoaded', function() {
    const clearButton = document.querySelector('.clearLogs-button');
    if (clearButton) {
        clearButton.onclick = clearModalLogs;
    }
});

document.addEventListener('DOMContentLoaded', function() {

    // Attach event listeners to the buttons
    document.querySelector('.select-all-logs-button').addEventListener('click', selectAllLogs);
    document.querySelector('.unselect-all-logs-button').addEventListener('click', unselectAllLogs);
    document.querySelector('.delete-selected-logs-button').addEventListener('click', deleteSelectedLogs);

});

function selectAllLogs() {
    const logEntries = document.querySelectorAll('.modalLogs-body .log-entry');
    logEntries.forEach(entry => {
        const checkbox = entry.querySelector('.log-checkbox');
        if (checkbox && entry.style.display !== 'none') {
            checkbox.checked = true;
        }
    });
}

function unselectAllLogs() {
    const logEntries = document.querySelectorAll('.modalLogs-body .log-entry');
    logEntries.forEach(entry => {
        const checkbox = entry.querySelector('.log-checkbox');
        if (checkbox && entry.style.display !== 'none') {
            checkbox.checked = false;
        }
    });
}


async function deleteSelectedLogs() {
    const checkboxes = document.querySelectorAll('.log-checkbox');
    const batch = writeBatch(db);
    let hasDeletions = false;

    // Check if any checkboxes are selected
    checkboxes.forEach((checkbox) => {
        if (checkbox.checked) {
            hasDeletions = true;
        }
    });

    // Proceed only if there is something to delete and the user confirms the action
    if (hasDeletions && confirm("Do you want to delete the selected logs?")) {
        checkboxes.forEach((checkbox) => {
            if (checkbox.checked) {
                const docId = checkbox.getAttribute('data-doc-id');
                if (docId) {
                    const docRef = doc(db, "hlogs", docId);
                    batch.delete(docRef);
                }
            }
        });

        try {
            await batch.commit();
            console.log("Selected logs have been deleted from Firestore.");
            displayLogs(); // Refresh log display after deletion
            alert("Logs successfully deleted."); // Alert the user that logs were successfully deleted
        } catch (error) {
            console.error("Error deleting selected logs: ", error);
            alert("Failed to delete logs. Please try again."); // Inform the user if deletion fails
        }
    } else if (!hasDeletions) {
        console.log("No logs selected for deletion."); // Inform user if no logs were selected
    }
}



</script>


<div id="addAccountModal" class="modalAdd">
    <div class="modal-content">
        <span class="close-buttonAdd">&times;</span>
        <form id="addAccountForm">
            <h2>Add New Account</h2>
            <input type="text" id="fullName" placeholder="Full Name" required>
            <input type="tel" id="phoneNumber" placeholder="Phone Number" required pattern="[0-9]{11}" maxlength="11" title="Phone number must be 11 digits long">
            <input type="email" id="email" placeholder="Email" required>
            <input type="password" id="password" placeholder="Password" required>
            <input type="password" id="confirmPassword" placeholder="Confirm Password" required>
            <button type="submit" class="modal-account-submit">Submit</button>
        </form>
    </div>
</div>

<div id="updateAccountModal" class="modalAdd">
    <div class="modal-content">
        <span class="close-buttonUpdate">&times;</span>
        <form id="updateAccountForm">
            <div class="modal-header">
                <h2>Update Account</h2>
                <!-- Dropdown for the Update Modal -->
                <select id="updateRole" class="update-role-select">
                    <option value="">Select Account</option>
                </select>
            </div>
            <input type="text" id="updateFullName" placeholder="Full Name" required>
            <input type="tel" id="updatePhoneNumber" placeholder="Phone Number" required pattern="[0-9]{11}" maxlength="11" title="Phone number must be 11 digits long">
            <input type="email" id="updateEmail" placeholder="Email" required>
            <input type="password" id="updatePassword" placeholder="Password" required>
            <button type="submit" class="modal-update-submit">Update</button>
        </form>
    </div>
</div>

<div class="modalLogs-background">
    <div class="modalLogs">
        <div class="modalLogs-header">
            <span>Log History</span>
            <input type="text" id="searchLogs" placeholder="Search logs...">
            <button class="closeLogs-button">x</button>
        </div>
        <div class="modalLogs-body">
            <!-- Log entries will be displayed here -->
        </div>
        <div class="modalLogs-footer">
            <button class="select-all-logs-button">Select All</button>
            <button class="unselect-all-logs-button">Unselect All</button>
            <button class="delete-selected-logs-button">Delete Selected</button>
            <button class="clearLogs-button" onclick="clearModalLogs()">Clear All Logs</button>
        </div>
    </div>
</div>


<div class="pagination">
    <a href="#" onclick="previousPage()" class="prev">Previous</a>
    <a href="#" onclick="nextPage()" class="next">Next</a>
</div>

<script src="dash.js"></script>
</body>
</html>
